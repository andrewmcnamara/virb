#!/usr/bin/env ruby

trap("INT") { 
  exec "kill 0"
}

`rm -rf .virb`
`mkdir -p .virb`
unless File.exist?('.virb/fifo')
  `mkfifo .virb/fifo`
end
`touch .virb/session`

vimscript = File.join(File.dirname(__FILE__), '..', 'lib', 'virb.vim')

# strip args so IRB doesn't think it's loading a file
args = ARGV.dup

while ARGV.shift
  # pass
end

fork do
  require './lib/virb.rb' 
end

exec("vim -S #{vimscript} #{args.join(' ')}")

# cleanup
`rm -rf .virb`

# This cleans up all subprocesses, including children spawned by the script cmd
exec "kill 0"

